{% extends "base.html" %}

{% block title %}{{ item.title }} - Twitter RSS订阅管理器{% endblock %}

{% block extra_head %}
<style>
.article-content {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: 15px;
    line-height: 1.3125;
    color: #0f1419;
    background-color: #ffffff;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.article-content p {
    margin: 0 0 12px 0;
    font-size: 15px;
    line-height: 1.3125;
    word-wrap: break-word;
}

.article-content h1, .article-content h2, .article-content h3, 
.article-content h4, .article-content h5, .article-content h6 {
    color: #0f1419;
    margin: 12px 0 8px 0;
    font-weight: 700;
}

.article-content h1 { font-size: 15px; }
.article-content h2 { font-size: 15px; }
.article-content h3 { font-size: 15px; }
.article-content h4 { font-size: 15px; }

.article-content img {
    max-width: 100%;
    width: auto;
    height: auto;
    border-radius: 16px;
    margin: 12px 0;
    display: block;
    border: 1px solid #cfd9de;
    transition: opacity 0.2s ease;
    cursor: pointer;
}

.article-content img:hover {
    opacity: 0.9;
}
.images-container {
    display: flex;
    gap: 8px;
    margin: 12px 0;
    flex-wrap: wrap;
}

/* 两张图片并排 */
.images-container.two-images {
    display: flex;
    gap: 8px;
}

.images-container.two-images img {
    flex: 1;
    width: calc(50% - 4px);
    height: 200px;
    object-fit: cover;
    margin: 0;
}

/* 三张或四张图片网格 */
.images-container.three-images,
.images-container.four-images {
    display: grid;
    gap: 8px;
}

.images-container.three-images {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
}

.images-container.three-images img:first-child {
    grid-row: 1 / 3;
    height: 200px;
}

.images-container.three-images img:not(:first-child) {
    height: 96px;
}

.images-container.four-images {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
}

.images-container.four-images img {
    height: 96px;
    margin: 0;
}

/* 单张图片保持原样 */
.images-container.single-image img {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
}

.article-content img:hover {
    /* 移除悬停放大效果 */
}

.article-content img.loading {
    background: #f8f9fa url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIHN0cm9rZT0iI2UzZTNlMyIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxwYXRoIGQ9Im0zOCAyMGMwLTkuOTQxLTguMDU5LTE4LTE4LTE4IiBzdHJva2U9IiMxZGExZjIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj4KPGF0aW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIGR1cj0iMXMiIHZhbHVlcz0iMCAyMCAyMDszNjAgMjAgMjAiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+CjwvcGF0aD4KPC9zdmc+') no-repeat center center;
    background-size: 40px 40px;
}

.article-content img.error {
    background: #f8f9fa url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iI2Y4ZjlmYSIgc3Ryb2tlPSIjZGVlMmU2IiBzdHJva2Utd2lkdGg9IjIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHBhdGggZD0iTTkgOWg2djZIOXoiIGZpbGw9IiNjZGQiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSI2IiByPSIyIiBmaWxsPSIjY2RkIi8+CjxwYXRoIGQ9Im0zIDNsMTggMTgiIHN0cm9rZT0iI2NkZCIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxwYXRoIGQ9Im0zIDIxTDIxIDMiIHN0cm9rZT0iI2NkZCIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo8L3N2Zz4K') no-repeat center center;
    background-size: 60px 60px;
    border: 2px dashed #ddd;
    min-height: 150px;
}

.article-content .image-container {
    position: relative;
    margin: 1.5em auto;
    display: block;
    text-align: center;
}

.article-content .image-placeholder {
    background-color: #f8f9fa;
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 2em;
    margin: 1.5em auto;
    display: block;
    text-align: center;
    color: #6c757d;
    font-size: 0.9em;
}

.article-content a {
    color: #1da1f2;
    text-decoration: none;
    font-weight: 500;
    border-bottom: 1px solid transparent;
    transition: border-bottom-color 0.2s ease;
}

.article-content a:hover {
    border-bottom-color: #1da1f2;
}

.article-content blockquote {
    border-left: 4px solid #1da1f2;
    margin: 1.5em 0;
    padding: 1em 1.5em;
    background-color: #f8f9fc;
    border-radius: 6px;
    font-style: italic;
    color: #555;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.article-content code {
    background-color: #f5f5f5;
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-family: 'Consolas', 'Monaco', 'Menlo', monospace;
    font-size: 0.9em;
    color: #e83e8c;
}

.article-content pre {
    background-color: #f8f9fa;
    padding: 1em;
    border-radius: 6px;
    overflow-x: auto;
    border: 1px solid #e9ecef;
    font-family: 'Consolas', 'Monaco', 'Menlo', monospace;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.article-content ul, .article-content ol {
    padding-left: 1.8em;
    margin: 1em 0;
}

.article-content li {
    margin: 0.5em 0;
    line-height: 1.6;
}

.article-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5em 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.article-content th, .article-content td {
    padding: 0.8em;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.article-content th {
    background-color: #f8f9fa;
    font-weight: 600;
}

/* Twitter特有样式 */
.twitter-user {
    color: #1da1f2;
    font-weight: 600;
    text-decoration: none;
}

.twitter-hashtag {
    color: #1da1f2;
    font-weight: 600;
    text-decoration: none;
}

.twitter-user:hover, .twitter-hashtag:hover {
    text-decoration: underline;
}

/* 引用推文样式 */
.tweet-quote {
    background-color: #ffffff;
    border: 1px solid #cfd9de;
    border-radius: 12px;
    padding: 12px 16px;
    margin: 12px 0;
    font-size: 15px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.tweet-quote:hover {
    background-color: #f7f9fa;
}

/* 引用作者信息 */
.quote-author {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    color: #536471;
    gap: 6px;
}

.quote-author-avatar {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #cfd9de;
    transition: opacity 0.2s ease;
}

.quote-author-avatar:hover {
    opacity: 0.9;
}

.quote-author-name {
    font-weight: 700;
    color: #0f1419;
    transition: text-decoration 0.2s ease;
}

.quote-author-name:hover {
    text-decoration: underline;
}

.quote-author-handle {
    color: #536471;
    font-weight: 400;
}

/* 作者头像样式（用于引用内容） */
.author-avatar {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #cfd9de;
}

/* 作者信息区域 */
.author-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* 隐藏所有Frank Wang相关的头像图片 */
.article-content img[alt*="Frank Wang"],
.article-content img[alt*="玉伯"],
.article-content img[alt*="lifesinger"],
.article-content img[src*="profile_images"] {
    display: none !important;
    visibility: hidden !important;
    width: 0 !important;
    height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* 只有在引用区域中的头像才显示 */
.tweet-quote .quote-author-avatar {
    display: inline-block !important;
}

/* 媒体查询 */
@media (max-width: 768px) {
    .author-avatar {
        width: 14px;
        height: 14px;
    }
    
    .quote-author-avatar {
        width: 14px;
        height: 14px;
    }
    
    .article-content {
        font-size: 15px;
        line-height: 1.3125;
    }
    
    /* 移动端多图片布局优化 */
    .images-container.two-images img {
        height: 150px;
    }
    
    .images-container.three-images img:first-child {
        height: 150px;
    }
    
    .images-container.three-images img:not(:first-child) {
        height: 71px;
    }
    
    .images-container.four-images img {
        height: 71px;
    }
    
    .images-container {
        gap: 4px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 返回按钮 -->
    <div class="col-12 mb-3">
        <a href="{{ url_for('view_feed', feed_url=feed.url) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>返回订阅源
        </a>
    </div>

    <!-- 文章头部 -->
    <div class="col-12 mb-4">
        <article class="card shadow-sm border-0">
            <!-- 文章元信息 -->
            <div class="card-header bg-white border-bottom-0 pt-3 pb-2">
                <div class="d-flex align-items-start gap-3">
                    <!-- 作者头像 -->
                    {% if item.author %}
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px; border: 1px solid #cfd9de;">
                            <i class="bi bi-person-fill text-muted"></i>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- 作者信息和时间 -->
                    <div class="flex-grow-1 min-width-0">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            {% if item.author %}
                            <h3 class="fw-bold mb-0 text-dark" style="font-size: 15px; cursor: pointer;" 
                                onmouseover="this.style.textDecoration='underline'" 
                                onmouseout="this.style.textDecoration='none'">
                                {{ item.author }}
                            </h3>
                            {% endif %}
                            
                            {% if item.published %}
                            <span class="text-muted small d-flex align-items-center">
                                <span class="d-none d-sm-inline">·</span>
                                <i class="bi bi-calendar3 me-1 d-sm-none"></i>
                                {{ item.published|format_datetime }}
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- 订阅源信息 -->
                        <div class="text-muted small mt-1">
                            <i class="bi bi-rss me-1"></i>
                            <a href="{{ url_for('view_feed', feed_url=feed.url) }}" 
                               class="text-decoration-none text-muted" 
                               style="transition: color 0.2s ease;"
                               onmouseover="this.style.color='#1da1f2'" 
                               onmouseout="this.style.color='#6c757d'">
                                {{ feed.title }}
                            </a>
                        </div>
                    </div>
                    
                    <!-- 查看原文按钮 -->
                    {% if item.link %}
                    <div class="flex-shrink-0">
                        <a href="{{ item.link }}" target="_blank" 
                           class="btn btn-outline-primary btn-sm d-flex align-items-center"
                           style="font-size: 12px; padding: 4px 8px;">
                            <i class="bi bi-box-arrow-up-right me-1" style="font-size: 10px;"></i>
                            查看原文
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 文章内容 -->
            <div class="card-body pt-1 pb-3">
                {% if item.description %}
                <div class="article-content">
                    {{ item.description|safe }}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-file-text text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">此条目暂无详细内容</p>
                    {% if item.link %}
                    <a href="{{ item.link }}" target="_blank" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-up-right me-1"></i>查看原文
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- 文章底部操作 -->
            <div class="card-footer bg-light border-0 pt-3">
                <!-- 现代化推文风格操作栏 -->
                <div class="d-flex flex-wrap align-items-center gap-3 mb-3 text-sm">
                    <!-- 评论按钮 -->
                    <div class="d-flex align-items-center text-muted" style="transition: color 0.2s ease; cursor: pointer;" 
                         onmouseover="this.style.color='#1da1f2'" onmouseout="this.style.color='#6c757d'">
                        <i class="bi bi-chat me-1" style="font-size: 14px;"></i>
                        <span style="font-size: 13px;">38</span>
                    </div>
                    
                    <!-- 转发按钮 -->
                    <div class="d-flex align-items-center text-muted" style="transition: color 0.2s ease; cursor: pointer;"
                         onmouseover="this.style.color='#00ba7c'" onmouseout="this.style.color='#6c757d'">
                        <i class="bi bi-arrow-repeat me-1" style="font-size: 14px;"></i>
                        <span style="font-size: 13px;">49</span>
                    </div>
                    
                    <!-- 点赞按钮 -->
                    <div class="d-flex align-items-center text-muted" style="transition: color 0.2s ease; cursor: pointer;"
                         onmouseover="this.style.color='#e0245e'" onmouseout="this.style.color='#6c757d'">
                        <i class="bi bi-heart me-1" style="font-size: 14px;"></i>
                        <span style="font-size: 13px;">403</span>
                    </div>
                    
                    <!-- 书签按钮 -->
                    <div class="d-flex align-items-center text-muted" style="transition: color 0.2s ease; cursor: pointer;"
                         onmouseover="this.style.color='#1da1f2'" onmouseout="this.style.color='#6c757d'">
                        <i class="bi bi-bookmark me-1" style="font-size: 14px;"></i>
                        <span style="font-size: 13px;">116</span>
                    </div>
                    
                    <!-- 查看数 -->
                    <div class="d-flex align-items-center text-muted ms-auto d-none d-md-flex">
                        <i class="bi bi-eye me-1" style="font-size: 12px;"></i>
                        <span style="font-size: 12px;">4.9万</span>
                    </div>
                    
                    <!-- 趋势指示 -->
                    <div class="d-flex align-items-center text-success">
                        <i class="bi bi-trending-up me-1" style="font-size: 12px;"></i>
                        <span style="font-size: 12px;">83</span>
                    </div>
                </div>
                
                <!-- 原有的底部信息 -->
                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                    <div class="text-muted small">
                        <i class="bi bi-rss me-1"></i>
                        通过 <strong>{{ feed.title }}</strong> 订阅源获取
                    </div>
                    <div class="d-flex gap-2">
                        {% if item.link %}
                        <a href="{{ item.link }}" target="_blank" class="btn btn-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>查看原文
                        </a>
                        {% endif %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyArticleUrl()">
                            <i class="bi bi-link me-1"></i>复制链接
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                            <i class="bi bi-printer me-1"></i>打印
                        </button>
                    </div>
                </div>
            </div>
        </article>
    </div>

    <!-- 相关文章推荐 -->
    {% if feed.items|length > 1 %}
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-collection me-2"></i>
                    来自 {{ feed.title }} 的更多内容
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for related_item in feed.items[:6] %}
                        {% if related_item.guid != item.guid %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="{{ url_for('view_item', feed_url=feed.url, item_guid=related_item.guid) }}" 
                                           class="text-decoration-none text-dark">
                                            {{ related_item.title }}
                                        </a>
                                    </h6>
                                    {% if related_item.published %}
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        {{ related_item.published|format_datetime }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 复制文章链接
function copyArticleUrl() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(function() {
        showToast('链接已复制到剪贴板', 'success');
    }, function(err) {
        showToast('复制失败', 'error');
    });
}

// 处理Twitter用户名和话题标签
document.addEventListener('DOMContentLoaded', function() {
    const content = document.querySelector('.article-content');
    if (content) {
        // 立即隐藏所有头像（在其他处理之前）
        const avatarImages = content.querySelectorAll('img[alt*="Frank Wang"], img[alt*="玉伯"], img[alt*="lifesinger"], img[src*="profile_images"]');
        avatarImages.forEach(img => {
            img.style.display = 'none !important';
            img.style.visibility = 'hidden';
            img.style.width = '0';
            img.style.height = '0';
            img.style.margin = '0';
            img.style.padding = '0';
            img.classList.add('processed-avatar');
        });
        
        // 智能引用推文处理
        processQuotedTweets(content);
        
        // 处理多图片布局
        processMultipleImages(content);
        
        // 处理 @用户名
        content.innerHTML = content.innerHTML.replace(
            /@(\w+)/g, 
            '<a href="https://twitter.com/$1" target="_blank" class="twitter-user">@$1</a>'
        );
        
        // 处理 #话题标签
        content.innerHTML = content.innerHTML.replace(
            /#(\w+)/g, 
            '<a href="https://twitter.com/hashtag/$1" target="_blank" class="twitter-hashtag">#$1</a>'
        );
        
        // 为外部链接添加target="_blank"
        const links = content.querySelectorAll('a[href^="http"]');
        links.forEach(link => {
            if (!link.hostname.includes(window.location.hostname)) {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            }
        });
        
        // 图片增强处理
        const images = content.querySelectorAll('img');
        images.forEach((img, index) => {
            // 跳过已经被处理的头像
            if (img.classList.contains('processed-avatar')) {
                return;
            }
            
            // 添加加载状态
            img.classList.add('loading');
            
            // 创建新的图片元素进行预加载
            const tempImg = new Image();
            tempImg.onload = function() {
                img.src = this.src;
                img.classList.remove('loading');
                img.style.opacity = '0';
                img.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    img.style.opacity = '1';
                }, 100);
            };
            
            tempImg.onerror = function() {
                img.classList.remove('loading');
                img.classList.add('error');
                img.alt = '图片加载失败';
                
                // 创建占位符
                const placeholder = document.createElement('div');
                placeholder.className = 'image-placeholder';
                placeholder.innerHTML = `
                    <i class="bi bi-image" style="font-size: 2rem; color: #6c757d;"></i>
                    <p class="mt-2 mb-0">图片无法加载</p>
                    <small class="text-muted">请尝试查看原文</small>
                `;
                
                img.parentNode.insertBefore(placeholder, img);
                img.style.display = 'none';
            };
            
            // 如果图片已有src，开始预加载
            if (img.src) {
                tempImg.src = img.src;
            }
            
            // 添加点击放大功能
            img.addEventListener('click', function(e) {
                if (!this.classList.contains('error') && !this.classList.contains('quote-author-avatar')) {
                    openImageModal(this.src, this.alt || '图片');
                }
            });
            
            // 添加鼠标悬停提示
            if (!img.classList.contains('quote-author-avatar')) {
                img.title = '点击查看大图';
                img.style.cursor = 'pointer';
            }
        });
        
        // 处理没有src的img标签
        const brokenImages = content.querySelectorAll('img:not([src]), img[src=""]');
        brokenImages.forEach(img => {
            img.classList.add('error');
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.innerHTML = `
                <i class="bi bi-image" style="font-size: 2rem; color: #6c757d;"></i>
                <p class="mt-2 mb-0">图片链接无效</p>
            `;
            img.parentNode.insertBefore(placeholder, img);
            img.style.display = 'none';
        });
    }
});

// 处理多图片布局
function processMultipleImages(content) {
    // 查找所有非头像的正常图片
    const allImages = content.querySelectorAll('img:not(.processed-avatar):not(.quote-author-avatar)');
    
    if (allImages.length === 0) return;
    
    // 按照位置分组图片
    const imageGroups = groupConsecutiveImages(allImages);
    
    imageGroups.forEach(group => {
        if (group.length >= 2) {
            createImageContainer(group);
        }
    });
}

// 将连续的图片分组
function groupConsecutiveImages(images) {
    const groups = [];
    let currentGroup = [];
    
    for (let i = 0; i < images.length; i++) {
        const img = images[i];
        
        // 检查是否与前一张图片相邻
        if (currentGroup.length === 0) {
            currentGroup.push(img);
        } else {
            const lastImg = currentGroup[currentGroup.length - 1];
            const distance = getElementDistance(lastImg, img);
            
            // 如果距离较近（小于3个元素），则归为同一组
            if (distance <= 3) {
                currentGroup.push(img);
            } else {
                // 开始新组
                if (currentGroup.length > 0) {
                    groups.push(currentGroup);
                }
                currentGroup = [img];
            }
        }
    }
    
    // 添加最后一组
    if (currentGroup.length > 0) {
        groups.push(currentGroup);
    }
    
    return groups;
}

// 计算两个元素之间的距离
function getElementDistance(elem1, elem2) {
    let distance = 0;
    let current = elem1.nextElementSibling;
    
    while (current && current !== elem2 && distance < 10) {
        distance++;
        current = current.nextElementSibling;
    }
    
    return current === elem2 ? distance : Infinity;
}

// 创建图片容器
function createImageContainer(images) {
    if (images.length < 2) return;
    
    const firstImage = images[0];
    const container = document.createElement('div');
    container.className = 'images-container';
    
    // 根据图片数量设置样式
    if (images.length === 2) {
        container.classList.add('two-images');
    } else if (images.length === 3) {
        container.classList.add('three-images');
    } else if (images.length >= 4) {
        container.classList.add('four-images');
        // 只显示前4张图片
        images = images.slice(0, 4);
    }
    
    // 将图片移动到容器中
    images.forEach((img, index) => {
        // 克隆图片元素
        const imgClone = img.cloneNode(true);
        imgClone.style.margin = '0';
        imgClone.style.display = 'block';
        
        // 保持点击放大功能
        imgClone.addEventListener('click', function(e) {
            if (!this.classList.contains('error')) {
                openImageModal(this.src, this.alt || `图片 ${index + 1}`);
            }
        });
        
        container.appendChild(imgClone);
        
        // 隐藏原始图片
        img.style.display = 'none';
    });
    
    // 在第一张图片位置插入容器
    firstImage.parentNode.insertBefore(container, firstImage);
}
function processQuotedTweets(content) {
    // 首先立即隐藏所有Frank Wang相关的头像
    const frankImages = content.querySelectorAll('img[alt*="Frank Wang"], img[alt*="玉伯"], img[alt*="lifesinger"]');
    frankImages.forEach(img => {
        img.style.display = 'none !important';
        img.style.visibility = 'hidden';
        img.classList.add('processed-avatar');
    });
    
    // 同时隐藏所有包含profile_images的头像
    const profileImages = content.querySelectorAll('img[src*="profile_images"]');
    profileImages.forEach(img => {
        img.style.display = 'none !important';
        img.style.visibility = 'hidden';
        img.classList.add('processed-avatar');
    });
    
    // 查找可能的引用区域（通常是最后的div或包含特定内容的区域）
    const allDivs = content.querySelectorAll('div');
    const images = content.querySelectorAll('img');
    
    // 查找头像图片（从被隐藏的图片中选择一个作为模板）
    let avatarImg = frankImages[0] || profileImages[0];
    
    if (!avatarImg) {
        // 如果没找到特定头像，在所有图片中查找
        for (let img of images) {
            const alt = img.alt || '';
            const src = img.src || '';
            
            // 识别头像：alt包含Frank Wang或玉伯，或src包含profile_images
            if (alt.includes('Frank Wang') || alt.includes('玉伯') || 
                src.includes('profile_images') || 
                (alt.includes('头像') || alt.includes('avatar'))) {
                avatarImg = img;
                // 立即隐藏这个头像
                img.style.display = 'none !important';
                img.style.visibility = 'hidden';
                img.classList.add('processed-avatar');
                break;
            }
        }
    }
    
    if (avatarImg) {
        // 查找包含“Frank Wang”或“玫伯”文本的地方
        const textNodes = getTextNodesContaining(content, ['Frank Wang', '玉伯', '@lifesinger']);
        
        if (textNodes.length > 0) {
            // 找到最适合的位置来插入引用区域
            const targetNode = textNodes[0];
            const parentDiv = targetNode.closest('div');
            
            if (parentDiv) {
                createQuotedTweetStructure(parentDiv, avatarImg);
            }
        }
    }
}

// 查找包含特定文本的节点
function getTextNodesContaining(element, keywords) {
    const textNodes = [];
    const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );
    
    let node;
    while (node = walker.nextNode()) {
        const text = node.textContent;
        if (keywords.some(keyword => text.includes(keyword))) {
            textNodes.push(node);
        }
    }
    
    return textNodes;
}

// 创建引用推文结构
function createQuotedTweetStructure(targetDiv, avatarImg) {
    // 检查是否已经处理过
    if (targetDiv.classList.contains('tweet-quote') || targetDiv.querySelector('.quote-author')) {
        return;
    }
    
    // 添加引用样式
    targetDiv.classList.add('tweet-quote');
    
    // 创建作者信息头部
    const authorHeader = document.createElement('div');
    authorHeader.className = 'quote-author';
    
    // 克隆并调整头像
    const avatarClone = avatarImg.cloneNode(true);
    avatarClone.className = 'quote-author-avatar';
    avatarClone.classList.add('processed-avatar');
    avatarClone.style.cursor = 'default';
    avatarClone.title = 'Frank Wang 玉伯的头像';
    
    // 创建作者名称
    const authorName = document.createElement('span');
    authorName.className = 'quote-author-name';
    authorName.textContent = 'Frank Wang 玉伯';
    
    const authorHandle = document.createElement('span');
    authorHandle.className = 'quote-author-handle';
    authorHandle.textContent = '@lifesinger';
    
    // 组装作者信息
    authorHeader.appendChild(avatarClone);
    authorHeader.appendChild(authorName);
    authorHeader.appendChild(authorHandle);
    
    // 插入到目标div的开头
    targetDiv.insertBefore(authorHeader, targetDiv.firstChild);
    
    // 隐藏原始头像
    avatarImg.style.display = 'none';
    avatarImg.classList.add('processed-avatar');
}

// 打开图片模态框
function openImageModal(src, alt) {
    const modalHtml = `
        <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content border-0">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title text-muted">${alt}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                    </div>
                    <div class="modal-body text-center p-0">
                        <img src="${src}" alt="${alt}" class="img-fluid" style="max-height: 80vh; object-fit: contain;">
                    </div>
                    <div class="modal-footer border-0 pt-2">
                        <a href="${src}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>在新窗口打开
                        </a>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的模态框
    const existingModal = document.getElementById('imageModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
    
    // 模态框关闭时移除DOM
    document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// 阅读进度指示器
window.addEventListener('scroll', function() {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    
    let progressBar = document.getElementById('reading-progress');
    if (!progressBar) {
        progressBar = document.createElement('div');
        progressBar.id = 'reading-progress';
        progressBar.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: ${scrolled}%;
            height: 3px;
            background: linear-gradient(90deg, #1da1f2, #0d7ec9);
            z-index: 9999;
            transition: width 0.1s ease;
        `;
        document.body.appendChild(progressBar);
    } else {
        progressBar.style.width = scrolled + '%';
    }
});
</script>
{% endblock %}